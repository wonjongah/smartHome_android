### 스마트 홈 프로젝트 한돌, 안드로이드

#### 개발 환경
- android studio 이용, kotlin 사용

#### 기능

- 아두이노의 센서와 모터의 MQTT를 라즈베리파이에서 받아 가공 뒤 안드로이드로 MQTT pub -> 세탁기 진동, 전등 ON/OFF 상태, 온도, 습도, 창문 ON/OFF 상태, 가스와 화재 상태 activity와 각 방의 fragment에서 확인 가능
- socket 통신을 통해 모터, LED 제어 
- 불이 나거나, 낯선 사람이 감지되었을 경우 확인하고 전화 혹은 문자 신고 가능
- 얼굴 인식 도어락 겸 CCTV -> 얼굴 등록 가능(사진을 찍거나 선택해서 등록하면 서버에 사진 등록)
                          -> 실시간 CCTV(라즈베리파이 웹캠 서버에서 돌리는 url을 웹뷰에 띄움)


![스크린샷(75)](https://user-images.githubusercontent.com/50413112/103846045-aa994580-50e0-11eb-90d9-351cda6e27f9.png)
![스크린샷(77)](https://user-images.githubusercontent.com/50413112/103846072-b84ecb00-50e0-11eb-9f3f-f691e9d2fe8e.png)
![스크린샷(78)](https://user-images.githubusercontent.com/50413112/103846086-bf75d900-50e0-11eb-925b-3ca88abc094a.png)
![스크린샷(79)](https://user-images.githubusercontent.com/50413112/103846096-c3096000-50e0-11eb-8c37-8d2810ecc93f.png)
![스크린샷(76)](https://user-images.githubusercontent.com/50413112/103846105-c69ce700-50e0-11eb-8745-08089b272b8a.png)
![스크린샷(80)](https://user-images.githubusercontent.com/50413112/103846117-cac90480-50e0-11eb-911e-2259b0136750.png)
![스크린샷(81)](https://user-images.githubusercontent.com/50413112/103846125-cd2b5e80-50e0-11eb-9d61-40ba4fdd1454.png)
![스크린샷(82)](https://user-images.githubusercontent.com/50413112/103846133-d0264f00-50e0-11eb-9981-8d5228ee0ca9.png)

#### 프로젝트 과정

10/29 해야 할 일

- json으로 연결하는 방법
- on/off 스위치 안드로이드에 만들어서 모터 작동시켜보기
- 안드로이드에서 주기적으로 request 주고, 온습도 같은 데이터 받아서 화면 갱신



라즈베리파이에 계속 아두이노가 센서값을 보낸다

그걸 받을 때마다 라즈베리파이 변수(temp, humi)에 저장

안드로이드에 api로 요청을 하면 그 최근값을 받아와서 갱신



10/30 해야 할 일

- 안드로이드 틀 만들기



10/31 해야 할 일

- 안드로이드 틀 완성, 전체적인 ui 디자인
- 텍스트뷰, 이미지뷰.... (온습도, 등등) (ok)
- 클릭 이벤트
- 버튼 누르면 액티비티간 이동
- 소켓 통신 어떻게 해야 할 지
- 프레그먼트간 이동 (ok?)
- icon -> led, window, washer, gas, water, fire, cctv, weather (ok)
- 집 밖으로 나가면 wear you mask 알림 오기? 



11/2 해야 할 일

- 틀 완성 (cctv 어떻게?)
- 외출모드, on/off버튼 클릭 등 설정해보기
- led 밝기 조정 도전
- 라즈베리파이와 연동 (ok)



11/3 해야 할 일

- 외출모드 (액티비티에서 프레그먼트로 어떻게 데이터 전달하거나 연결?)
- led 밝기 조정 도전
- 주기적으로 라베파에 신호를 줘서 온도 습도 받아서 textView에 갱신하는 것
- cctv 대강 틀 잡기
- 상태 받아와서 on/off 갱신해서 뿌리기
- json, 잭슨, 해쉬맵

아두이노에서 led 상태 받아와서 -> on이면 on으로 나타내고 off면 off로 나타냄....
그 상태에서 on 버튼 누르면 off로 이미지 버튼 이미지가 바뀌면서 라베파에 통신



 텍스트로 온거 다 파싱하는데만 한세월 걸릴거같아서 json 쓰자고 한거거든요
 파싱 모듈 직접 만들어서 
바이트텍스트-> 파싱 -> 디코딩 ->안드로이드 내부 변수에 저장하는게 편하시면 그냥 텍스트로 보내는 식으로 하고 
그게 아니면 json 형태로 웹소캣 통신하려하는데
 어느게 더 편하실거같나요



임시로 [room] [sensor] [명령] 형태로 보내주세요
예시: living LED OFF
이러면 IoT3/home/living/LED 토픽으로 LED OFF 명령이 전송되도록 만들었습니다

- timer로 주기적으로 request 그때마다 json 받아와서 뿌리기 



안드로이드측에서 서버측으로 데이터 원할 때 
GET_[방이름]
모든 정보를 얻고 싶으면 GET_ALL

서버측으로 원격제어 명령어
[방이름]_[센서]_[옵션]:[값]
ex) living_LED_brig:200
     living_LED_ON   (LED 키는 명령어)

위 명령어는 아두이노 측에서는 이렇게 수신됨
    LED_brig:200
    LED_ON



mosquitto_sub -d -t iot_app



11/4 해야 할 일

- 받은 데이터 json으로 파싱해서 텍스트뷰와 버튼에 뿌리기
- 안드로이드 키거나 새로고침할 때마다 값을 받아와서 정렬하고 싶다
- 외출모드 (액티비티에서 프레그먼트로 어떻게 데이터 전달하거나 연결?)
- led 밝기 조정 도전
- cctv 틀 잡기



11/5 해야 할 일

- cctv 어떻게 해야 할 지, 틀 잡기랑 선생님이 주신 라이브러리 참고
- 받은 데이터 json으로 파싱해서 텍스트뷰와 버튼에 뿌리기 (1) (ok)
- -> 그런데 아두이노랑 라즈베리파이랑 연동해서 받아오는 걸 하고 싶다(세훈님이 주신 파일로 실험)
- 안드로이드 키거나 새로고침할 때마다 값을 받아와서 정렬하고 싶다
- 외출모드 (액티비티에서 프레그먼트로 어떻게 데이터 전달하거나 연결?) (2)
- -> 액티비티에 구현
- -> 버튼 누르면 아두이노에게 명령
- -> 프레그먼트에 데이터 전송해서 화면 세팅
- led 밝기 조정 도전 (3)
- cctv 틀 잡기 (ok)



API 날씨 불러오기

전체적으로 UI 수정



!!!!!! 화재, 누수, 가스가 발생하면 noti, 카톡 띄우기, 스위치 없애기

!!!!! 세탁기 X 



제어가능 -> 안방 창문(비 오면 자동으로 닫히게), 거실 창문(미세먼지 안 좋으면 알람을 줘서 창문 noti 열게한다), 전등



페이저 어댑터에 다음 추가

​    var currentFragment : 프래그먼트타입?=null

​    override fun setPrimaryItem(container: ViewGroup, position: Int, `object`: Any) {
​        if (currentFragment !== `object`) {
​            currentFragment = `object` as 프래그먼트타입
​        }
​        super.setPrimaryItem(container!!, position, `object`)

    }
----------------------------------

애티비티에서 현재 프래그먼트의 메서드 호출하기
val adapter = view_pager.adapter as 페이저어댑터타입
adapter.currentFragment?.controlOn()

---------------------------------

프래그먼트의 함수에서 리사이클러뷰 아이템 상태변경하기
fun controlOn() {
    ...
    어댑터에 전달한 리스트의 내용 수정 후
    리사이클러뷰.adapter.notifyDataSetChanged()	// 데이터 변경 통지 --> 리사인클러뷰가 자동 갱신
}

---------

뷰 홀더에서 상태에 따라 값 설정(다른 이미지 설정)



11/06 문제점

- 다른 탭으로 넘기면 화면 꺼짐... 리사이클러뷰 null 안 된다고 뜨고.......... (일단 오늘 제일 마지막에)(ok)
- 외출모드를 키면 아예 버튼이 바뀌지 않는 것 고치기 (xml을 두 개로 나누면 될 듯)(ok)
- led 밝기(ok)
- cctv 찾기
- 음성인식 찾아보기
- UI 수정 (ok)
- 창문 on off (ok)
- 방_WINDOW_OPEN (ok)



setPrimaryItem -> 현재 보여지고 있는 Fragment가 아닌 경우 보여지고 있는 Fragment로 바꾼다



11/07 해야 할 일

- cctv 웹뷰 띄우기 (1, 2)(ok)
- 날씨 API로 메인에 아이콘 바꾸기, 날짜 표시하기 (3)
- iot_app/info (주기정보), iot_app/emergency (긴급 정보) (1, 2)
- -> 긴급정보 받으면 notification 울리도록 (ok)

- all (창문 socket), 침실 (전등 socket) (ok)
- socket 클래스화 (ok)



웹뷰 띄울 때 기다리는 시간 동안 로딩바 만들 수 있다면...



11/08 해야 할 일

- 카메라 찍은 사진 이미지뷰에 띄우기 (ok)



11/09 해야 할 일

- 날씨 API 이용해 텍스트뷰와 아이콘 갱신하기
- 안드로이드에서 서버로 사진을 보내 unkowns 폴더에 저장하고 싶다고 하면 파일 자체를 전송해야 하는 것인지 아니면 사진을 하나하나 byte로 보내야 하는 것인지?? -> 찾아보고 안 나오면 일단 날씨 api와 센서 데이터 처음에 세팅하는 것 손보고 내일 물어보기
- -> 일단 파일을 이용해서 보내는 걸로 해서 보내는 것만 해놓자 (ok)
- -> 집 가서 라즈베리파이로 받는 지만 확인
- 갤러리 선택해서 이미지뷰에 띄우기(ok)
- 처음 로딩시 센서 데이터 갱신해놓기 
- -> 그밖의... 다른 곳에서 명령하면 안드로이드에서 어떻게 갱신할 것인가? 바뀔 때마다 서버에서 신호를 보내서 안드로이드에게 보내줘서 그걸 받아 세팅해야 하는가?

- 음성인식 찾아보기 -> 라베파에서 하는 일인 것 같긴 한데....

- 웹뷰 띄울 때 기다리는 시간 동안 로딩바 만들기(ok)

- ppt 중간 발표용도 추가해서 수정

- 취소 버튼 눌렀을 때 이전 액티비티로 돌아가기(ok)



-> 문제점, 일단 안드로이드에서 갤러리에서 파일 전송이 이름을 뭘 보내야 하는 지 모르겠음

-> 문제점2, 안드로이드에서 파일을 보내면 이게 정말 사진을 담은 파일을 보내서 서버에서 저장할 수 있는 것인지... 사진으로 byte로 변형해서 보내야 하는 것인지....

-> 해결 -> 파일 자체를 보내고 파일 자체를 받으면 되는 거였다



11/10 해야 할 일

- 날씨 API 이용해 텍스트뷰와 아이콘 갱신하기

- 처음 로딩시 센서 데이터 갱신해놓기

- -> 그밖의 다른 곳에서 명령하면 안드로이드에서 어떻게 갱신할 것인가? 바뀔 때마다 서버에서 신호를 보내서 안드로이드에게 보내주면 받아서 세팅해야 하는가?

- 음성인식 찾아보기 -> 할 수 있으면 라베파 소스 짜서 세훈님께 보내기

- ppt 중간 발표용 추가해서 수정하기(ok)

- 갤러리 선택 수정하기 (ok)

- 에디트 텍스트에 사진 이름도 같이 보내도록 수정 (파일이름(스페이스)파일크기) (ok)

- 등록하면 이전 액티비티로 돌아가게 하기 (ok) -> 갤러리는 갤러리 수정한 다음 하기 (ok)

- 사진 선택 등록 쪽 UI 수정하기 

- 수상한 사람 감지시 띄우는 노티 (snapshot 액티비티, 전화로 신고하기 문자로 신고하기)(ok)

- 버튼 없앨 것 없애기

- 데이터 불러와서 뿌리기........................................

- 문제점 => 외출모드로 했을 때 버튼이 안 바뀐다 (xml로 바꾸면 될 듯)

- 화재 감지시 신고 기능(ok)

- 세탁기 on off 추가 (ok)

- mqtt 받는 것 실험, topic(iot_app/emergency), message(living/DHT/Temp/HIGH)

- -> 슬라이싱해서 그에 따른 결과 뿌리기

- -> emergency/stop 오면 알림 끄도록

- 창문 각도 조절 액티비티 (ok)

- 창문 열 때 window_ open 이렇게 말고 iot3/home/window/info/숫자값.... (ok)

- 현관문 열림 닫힘 상태 텍스트뷰로 띄우기

- 갤러리 선택 사진 로테이션

  

  

창문과 led 조절

버튼을 그에 따라서 세팅해놓고 싶다..................



버튼이 바뀌는 경우의 수

처음 로딩할 때 => 데이터를 받아서 버튼 모양과 데이터 세팅

명령할 때 => 버튼을 바꾸기

음성인식으로 명령할 때 => 버튼 바꾸기



mqtt로 리시브를 하면 그에 따른 정보를 바꾼 후 nofity



가구 만들 것 침대, 세면대, 가스렌지, 세탁기, 소파



사람이 들어오면 잠금... 스톱..

그전까지 이머전시 계속 올 거임

스톱 오면 알림 끄도록.............................



물 안잠구고 일정시간 경과시
토픽:iot_app/emergency,
메세지: toilet/waterSensor/flood
사람이 들어오거나 물이 잠궈져있을 시
토픽:iot_app/emergency,
메세지: toilet/waterSensor/stop



11/11 해야 할 일

- 모형 색칠(ok)
- 버튼 바꾸기
- 라즈베리 아두이노 연동해서 신호 보내는 것 종류별로 
- mqtt 수신 시 noti, 데이터 뿌리기(일부 ok)
- 날씨 API
- 갤러리 선택 로테이션
- 음성인식 찾아보기 -> 할 수 있으면 라베파 소스 짜서 세훈님께 보내기
- 프레그먼트 값 바꾸는 건 전부 값 바꾸고 notify로
- 하고 있는 거 다 하고 시간 남으면 안드로이드에 소켓 돌려서 라즈베리파이에서 사진 받아서 모르는 사람 띄우게



11/12 해야 할 일

- 각 내부 액티비티 안에 데이터 뿌리기... 이것만 하면 수신은 어느정도 완료
- 버튼 고치기 (ok)
- ppt 수정 (ok)
- 틈틈이 UI 수정
- 갤러리 선택 로테이션 (ok)
- 하고 있는 거 다 하고 시간 남으면 안드로이드에 소켓 돌려서 라즈베리파이에서 사진 받아서 모르는 사람 띄우게
- notification split해서 케이스별로 나눠서 뜨게 하기
- 받은 상태에 따라서 버튼 바뀌게 조정 -> 전등과 창문, 문 있는 곳만 뿌리면 된다
- -> json 샘플 보내달라고 해서 실험하기
- 버튼 없앨 것 없애기 -> 전등과 창문, 문만 있게 (ok)
- 문 신호 보내기 door_door/ON or OFF (ok)
- 문자 수신 번호 수정 (ok)



- notification split해서 케이스별로 나눠서 뜨게 하기 -> 일단 ok 그런데 금요일에 실험해봐야 할 듯

- 각 내부 액티비티 안에 데이터 뿌리기... 이것만 하면 수신은 어느정도 완료

- 외출모드하면 텍스트도 닫힘.. 중지 잠김으로 바꾸기

- ui 수정 이미지 소켓은 일요일에 다 해버리기

  

11/13 해야 할 일

- 버튼과 각 센서의 상태에 따라서 바뀌게 하게끔.. 상태 읽어와서.. 그 다음에 식별하기

- -> 받아오는 건 잘하는데 갱신하는 게 안 된다 onCreate에서 해야 하는 건가?

- 노티 실험해보기 일단 논리로는 흘러감

- 각 내부 액티비티 손보기(ok)

- 틈틈이 ppt, ui 수정(ok)

- 타이틀바 없애기(ok)

  
